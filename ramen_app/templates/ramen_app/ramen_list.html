{% extends "base.html" %}
{% load static %}

{% block title %}„É©„Éº„É°„É≥Â∫óËàó‰∏ÄË¶ß{% endblock %}

{% block content %}
<!-- Leaflet.js „ÅÆ„Çπ„Çø„Ç§„É´„Å®„Çπ„ÇØ„É™„Éó„Éà„ÅÆË™≠„ÅøËæº„Åø -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    #map {
        height: 500px;
        width: 100%;
        margin-top: 20px;
    }
</style>

<div class="container">
    <h1 class="title">üçú „É©„Éº„É°„É≥Â∫óËàó‰∏ÄË¶ß üçú</h1>
    <form method="get" class="search-form">
        <input type="text" name="q" class="search-input" placeholder="Â∫óËàóÂêç„ÇÑÁâπÂæ¥„ÅßÊ§úÁ¥¢" value="{{ query }}">
        <button type="submit" class="search-button">Ê§úÁ¥¢</button>
    </form>
    
    <!-- Âú∞Âõ≥ÊèèÁîª„Ç®„É™„Ç¢ -->
    <div id="map"></div>

    <div class="shops-list">
        {% for shop in shops %}
        <div class="shop-card">
            <img 
                src="{% if shop.image_url %}{{ shop.image_url }}{% else %}{% static 'images/default.webp' %}{% endif %}" 
                alt="{{ shop.name }}" 
                class="shop-image">
            <h2 class="shop-name">{{ shop.name }}</h2>
            <p class="shop-distance">üö∂ {{ shop.distance_from_station }}</p>
            <p class="shop-features">{{ shop.features }}</p>
            <a href="{% url 'ramen_app:ramen_detail' shop.id %}" class="details-link">Ë©≥„Åó„ÅèË¶ã„Çã ‚û°Ô∏è</a>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    // Âú∞Âõ≥ÂàùÊúüÂåñ
    const map = L.map('map').setView([35.658581, 139.745433], 12); // „Éá„Éï„Ç©„É´„Éà„ÅØÊù±‰∫¨„Çø„ÉØ„Éº‰ªòËøë
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    locations.forEach(location => {
        if (location.lat && location.lng) {
            L.marker([location.lat, location.lng])
                .addTo(map)
                .bindPopup(`<b>${location.name}</b><br>${location.distance}`);
        }
    });

    // Â∫óËàó„Éá„Éº„Çø„ÇíÂú∞Âõ≥„Å´Ë°®Á§∫
    const locations = [
        {% for shop in shops %}
        {
            name: "{{ shop.name }}",
            lat: {{ shop.latitude|default:"null" }},
            lng: {{ shop.longitude|default:"null" }},
            distance: "{{ shop.distance_from_station }}"
        },
        {% endfor %}
    ];

    locations.forEach(location => {
        if (location.lat && location.lng) {
            L.marker([location.lat, location.lng])
                .addTo(map)
                .bindPopup(`<b>${location.name}</b><br>${location.distance}`);
        }
    });
</script>
{% endblock %}
